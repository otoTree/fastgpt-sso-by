# FastGPT SSO 服务开发指导文档

## 项目概述

FastGPT SSO 服务是一个专门为私有化用户提供单点登录(SSO)集成的服务。该服务支持多种认证协议和第三方身份提供商，包括 OAuth2.0、SAML2.0、CAS 等。

## 项目架构

### 核心文件结构

```
src/
├── index.ts              # 应用入口文件，Express 服务器配置
├── type.ts               # TypeScript 类型定义
├── controllers.ts        # 控制器，处理 HTTP 请求
├── middleware.ts         # 中间件，如身份验证
├── global.ts            # 全局状态管理
├── utils.ts             # 工具函数
├── userPrefix.ts        # 用户名前缀配置
└── provider/            # 身份提供商实现
    ├── index.ts         # 提供商注册和管理
    ├── test.ts          # 测试提供商
    ├── oauth2.ts        # 通用 OAuth2.0 提供商
    ├── feishu.ts        # 飞书集成
    ├── wecom.ts         # 企业微信集成
    ├── dingtalk.ts      # 钉钉集成
    ├── qilu.ts          # 齐鲁制药 IAM 集成
    ├── testSaml.ts      # SAML2.0 测试提供商
    ├── bjsf.ts          # BJSF SAML 提供商
    └── ...              # 其他提供商
```

### 核心概念

#### 1. 提供商 (Provider)
每个身份提供商都需要实现以下接口：

```typescript
interface Provider {
  redirectFn: RedirectFn;           // 生成认证跳转URL
  getUserInfo: GetUserInfoFn;       // 获取用户信息
  callbackFn?: CallbackFn;          // 处理回调（可选）
  getMetaData?: GetMetaDataFn;      // 获取SAML元数据（可选）
  assertFn?: AssertFn;              // 处理SAML断言（可选）
  getUserList?: GetUserListFn;      // 获取用户列表（可选）
  getOrgList?: GetOrgListFn;        // 获取组织列表（可选）
}
```

#### 2. 认证流程
1. 客户端请求 `/login/oauth/getAuthURL` 获取认证URL
2. 用户在第三方系统完成认证
3. 第三方系统回调到 `/login/oauth/callback` 或直接返回code
4. 客户端使用code调用 `/login/oauth/getUserInfo` 获取用户信息

## 开发环境搭建

### 前置要求
- Node.js 18+ 或 Bun
- 支持 TypeScript

### 安装步骤

1. **安装 Bun（推荐）**
   ```bash
   curl -fsSL https://bun.sh/install | bash
   ```

2. **克隆项目并安装依赖**
   ```bash
   git clone <repository-url>
   cd sso
   bun install
   ```

3. **配置环境变量**
   ```bash
   cp .env.template .env
   # 编辑 .env 文件，配置相应的环境变量
   ```

4. **启动开发服务器**
   ```bash
   bun run dev
   ```

## 添加新的身份提供商

### 步骤 1：创建提供商文件

在 `src/provider/` 目录下创建新的提供商文件，例如 `newprovider.ts`：

```typescript
import { RedirectFn, GetUserInfoFn } from '../type';
import axios from 'axios';

// 重定向函数 - 生成认证URL
export const newprovider_redirectFn: RedirectFn = async ({ redirect_uri, state }) => {
  const authUrl = process.env.NEWPROVIDER_AUTH_URL;
  const clientId = process.env.NEWPROVIDER_CLIENT_ID;
  
  const url = new URL(authUrl);
  url.searchParams.set('client_id', clientId);
  url.searchParams.set('redirect_uri', redirect_uri);
  url.searchParams.set('response_type', 'code');
  if (state) {
    url.searchParams.set('state', state);
  }
  
  return { redirectUrl: url.toString() };
};

// 获取用户信息函数
export const newprovider_getUserInfo: GetUserInfoFn = async (code: string) => {
  const tokenUrl = process.env.NEWPROVIDER_TOKEN_URL;
  const userInfoUrl = process.env.NEWPROVIDER_USERINFO_URL;
  const clientId = process.env.NEWPROVIDER_CLIENT_ID;
  const clientSecret = process.env.NEWPROVIDER_CLIENT_SECRET;
  
  // 1. 获取访问令牌
  const tokenResponse = await axios.post(tokenUrl, {
    grant_type: 'authorization_code',
    client_id: clientId,
    client_secret: clientSecret,
    code: code
  });
  
  const accessToken = tokenResponse.data.access_token;
  
  // 2. 获取用户信息
  const userResponse = await axios.get(userInfoUrl, {
    headers: {
      Authorization: `Bearer ${accessToken}`
    }
  });
  
  const userData = userResponse.data;
  
  return {
    username: userData.id,
    avatar: userData.avatar || '',
    contact: userData.email || userData.phone || '',
    memberName: userData.name || userData.username
  };
};
```

### 步骤 2：注册提供商

在 `src/provider/index.ts` 中注册新的提供商：

```typescript
// 1. 导入新提供商
import { newprovider_redirectFn, newprovider_getUserInfo } from './newprovider';

// 2. 在 providerMap 中添加配置
const providerMap = {
  // ... 其他提供商
  newprovider: {
    redirectFn: newprovider_redirectFn,
    getUserInfo: newprovider_getUserInfo
  }
};
```

### 步骤 3：添加环境变量

在 `.env.template` 中添加新提供商的配置模板：

```bash
# 新提供商 - newprovider
# SSO_PROVIDER=newprovider
# NEWPROVIDER_AUTH_URL=https://auth.newprovider.com/oauth/authorize
# NEWPROVIDER_TOKEN_URL=https://auth.newprovider.com/oauth/token
# NEWPROVIDER_USERINFO_URL=https://api.newprovider.com/user/me
# NEWPROVIDER_CLIENT_ID=your_client_id
# NEWPROVIDER_CLIENT_SECRET=your_client_secret
```

## 支持的认证协议

### 1. OAuth 2.0
标准的 OAuth 2.0 授权码流程，适用于大多数现代身份提供商。

**实现要点：**
- 实现 `redirectFn` 生成授权URL
- 实现 `getUserInfo` 处理授权码交换和用户信息获取

### 2. SAML 2.0
企业级单点登录标准，支持更复杂的身份验证场景。

**实现要点：**
- 需要配置 SP 证书和 IdP 证书
- 实现 `redirectFn`、`assertFn` 和 `getMetaData`
- 处理 SAML 断言和元数据

**证书生成：**
```bash
openssl req -x509 -newkey rsa:2048 -keyout sp.key -out sp.crt -days 365 -nodes
```

### 3. CAS
中央认证服务，常用于教育和政府机构。

**实现要点：**
- 实现 `redirectFn` 和 `callbackFn`
- 处理 ticket 验证

## 用户和组织同步

某些提供商支持用户和组织数据同步功能：

```typescript
// 获取用户列表
export const provider_getUserList: GetUserListFn = async () => {
  // 实现用户列表获取逻辑
  return [
    {
      username: 'user1',
      memberName: '用户1',
      avatar: 'https://example.com/avatar1.jpg',
      contact: 'user1@example.com',
      orgs: ['org1', 'org2']
    }
  ];
};

// 获取组织列表
export const provider_getOrgList: GetOrgListFn = async () => {
  // 实现组织列表获取逻辑
  return [
    {
      id: 'org1',
      name: '技术部',
      parentId: 'root'
    }
  ];
};
```

## 错误处理和调试

### 常见错误

1. **Invalid code**
   - 检查授权码是否正确
   - 确认授权码未过期
   - 验证回调URL配置

2. **Provider not found**
   - 检查 `SSO_PROVIDER` 环境变量
   - 确认提供商已在 `providerMap` 中注册

3. **Certificate errors (SAML)**
   - 检查证书文件路径
   - 验证证书格式和有效期
   - 确认 IdP 元数据配置

### 调试技巧

1. **启用详细日志**
   ```typescript
   console.log('Debug info:', { code, userInfo });
   ```

2. **使用测试提供商**
   ```bash
   SSO_PROVIDER=test
   ```

3. **检查网络请求**
   使用 axios 拦截器记录请求和响应

## 部署指南

### Docker 部署

1. **构建镜像**
   ```bash
   docker build -t fastgpt-sso .
   ```

2. **运行容器**
   ```bash
   docker run -p 3000:3000 --env-file .env fastgpt-sso
   ```

### 环境变量配置

**必需变量：**
- `SSO_PROVIDER`: 身份提供商名称
- `SSO_TARGET_URL`: 第三方认证URL
- `HOSTNAME`: 服务外部访问地址

**可选变量：**
- `AUTH_TOKEN`: API 访问令牌
- `REDIRECT`: 启用自动重定向
- `PORT`: 服务端口（默认3000）

## API 接口文档

### 获取认证URL
```
GET /login/oauth/getAuthURL?redirect_uri=<callback_url>&state=<state>
```

**响应：**
```json
{
  "success": true,
  "message": "",
  "authURL": "https://auth.provider.com/oauth/authorize?..."
}
```

### 获取用户信息
```
GET /login/oauth/getUserInfo?code=<authorization_code>
```

**响应：**
```json
{
  "username": "user123",
  "avatar": "https://example.com/avatar.jpg",
  "contact": "user@example.com",
  "memberName": "张三"
}
```

### 获取用户列表（需要认证）
```
GET /user/list
Authorization: Bearer <token>
```

### 获取组织列表（需要认证）
```
GET /org/list
Authorization: Bearer <token>
```

## 最佳实践

1. **安全性**
   - 妥善保管客户端密钥
   - 使用 HTTPS 传输
   - 验证回调URL
   - 实现适当的错误处理

2. **性能优化**
   - 缓存访问令牌
   - 实现连接池
   - 设置合理的超时时间

3. **可维护性**
   - 遵循统一的代码风格
   - 添加详细的注释
   - 编写单元测试
   - 记录配置变更

## 故障排除

### 检查清单

- [ ] 环境变量配置正确
- [ ] 网络连接正常
- [ ] 证书文件存在且有效（SAML）
- [ ] 回调URL配置匹配
- [ ] 客户端ID和密钥正确
- [ ] 服务端口未被占用

### 联系支持

如果遇到无法解决的问题，请提供以下信息：
- 错误日志
- 环境变量配置（隐藏敏感信息）
- 网络环境描述
- 复现步骤

---

**注意：** 本文档会随着项目发展持续更新，请定期查看最新版本。